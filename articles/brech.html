<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>brech • brech</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="brech">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">brech</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/brech.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/BCCDC-PHSA/brech/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>brech</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/BCCDC-PHSA/brech/blob/main/vignettes/brech.Rmd" class="external-link"><code>vignettes/brech.Rmd</code></a></small>
      <div class="d-none name"><code>brech.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'dplyr'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     filter, lag</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     intersect, setdiff, setequal, union</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://bccdc-phsa.github.io/brech/">brech</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>To create a model simulation we construct an R S3 object using the
<code>stochastic_model</code> class. This expects a list of reactions
including the <code>transitions</code>: the impact on the population and
<code>rate</code>: the rate at which the event takes place. e.g. the
first reaction represents an infection event that occurs at rate
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>β</mi><mi>S</mi><mi>I</mi></mrow><annotation encoding="application/x-tex">\beta S I</annotation></semantics></math>
where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>S</mi><annotation encoding="application/x-tex">S</annotation></semantics></math>
is the population of susceptible,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>I</mi><annotation encoding="application/x-tex">I</annotation></semantics></math>
is the population of infected and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>β</mi><annotation encoding="application/x-tex">\beta</annotation></semantics></math>
is the population infectivity.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">reactions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  infection <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    transition <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>S <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, E <span class="op">=</span> <span class="op">+</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>    rate <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">p</span>, <span class="va">t</span><span class="op">)</span> <span class="va">p</span><span class="op">$</span><span class="va">beta</span> <span class="op">*</span> <span class="va">x</span><span class="op">[</span><span class="st">"S"</span><span class="op">]</span> <span class="op">*</span> <span class="va">x</span><span class="op">[</span><span class="st">"I"</span><span class="op">]</span></span>
<span>  <span class="op">)</span>,</span>
<span>  incubation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    transition <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>E <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, I <span class="op">=</span> <span class="op">+</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>    rate <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">p</span>, <span class="va">t</span><span class="op">)</span> <span class="va">p</span><span class="op">$</span><span class="va">theta</span> <span class="op">*</span> <span class="va">x</span><span class="op">[</span><span class="st">"E"</span><span class="op">]</span></span>
<span>  <span class="op">)</span>,</span>
<span>  recovery <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    transition <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>I <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, R <span class="op">=</span> <span class="op">+</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>    rate <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">p</span>, <span class="va">t</span><span class="op">)</span> <span class="va">p</span><span class="op">$</span><span class="va">gamma</span> <span class="op">*</span> <span class="va">x</span><span class="op">[</span><span class="st">"I"</span><span class="op">]</span></span>
<span>  <span class="op">)</span>,</span>
<span>  case_detection <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    transition <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>C <span class="op">=</span> <span class="op">+</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>    rate <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">p</span>, <span class="va">t</span><span class="op">)</span> <span class="va">p</span><span class="op">$</span><span class="va">case_rate</span> <span class="op">*</span> <span class="va">x</span><span class="op">[</span><span class="st">"I"</span><span class="op">]</span></span>
<span>  <span class="op">)</span>,</span>
<span>  vaccinate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    transition <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>V <span class="op">=</span> <span class="op">+</span><span class="fl">1</span>, S <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>    rate <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">p</span>, <span class="va">t</span><span class="op">)</span> <span class="fl">0</span> <span class="op">*</span> <span class="va">x</span><span class="op">[</span><span class="st">"S"</span><span class="op">]</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">sim_scenario</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/load_model_params.html">load_model_params</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/vaccinate_initial_conditions.html">vaccinate_initial_conditions</a></span><span class="op">(</span><span class="fl">0.8</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/stochastic_model.html">update_parameters</a></span><span class="op">(</span>beta<span class="op">=</span><span class="fl">0.02</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stochastic_model.html">stochastic_model</a></span><span class="op">(</span><span class="va">reactions</span>,<span class="va">sim_scenario</span><span class="op">)</span></span>
<span><span class="va">sm</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB; font-weight: bold;">Stochastic Model</span> </span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">==================</span> </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BB00; font-weight: bold;">Initial Values:</span></span></span>
<span><span class="co">#&gt;   <span style="font-weight: bold;">S</span> : 200  <span style="font-weight: bold;">V</span> : 799  <span style="font-weight: bold;">E</span> : 0</span></span>
<span><span class="co">#&gt;   <span style="font-weight: bold;">I</span> : 1  <span style="font-weight: bold;">R</span> : 0  <span style="font-weight: bold;">C</span> : 0</span></span>
<span><span class="co">#&gt;   <span style="font-weight: bold;">D</span> : 0</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00; font-weight: bold;">Parameters:</span></span></span>
<span><span class="co">#&gt;   <span style="font-weight: bold;">r_0</span> : 25  <span style="font-weight: bold;">latent_period</span> : 11  <span style="font-weight: bold;">infectious_period</span> : 8</span></span>
<span><span class="co">#&gt;   <span style="font-weight: bold;">ascertainment_delay</span> : 2.5  <span style="font-weight: bold;">case_delay</span> : 3  <span style="font-weight: bold;">theta</span> : 0.0909</span></span>
<span><span class="co">#&gt;   <span style="font-weight: bold;">gamma</span> : 0.125  <span style="font-weight: bold;">case_rate</span> : 0.333  <span style="font-weight: bold;">beta</span> : 0.02</span></span>
<span><span class="co">#&gt;   <span style="font-weight: bold;">N</span> : 1000</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00; font-weight: bold;">Simulation arguments:</span></span></span>
<span><span class="co">#&gt;   <span style="font-weight: bold;">T</span> : 10</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00; font-weight: bold;">Reactions:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;"> - infection:</span></span></span>
<span><span class="co"><span style="color: #BBBB00; font-weight: bold;">#&gt; </span><span style="color: #555555;">   Transition: [S -1, E +1]</span></span></span>
<span><span class="co"><span style="color: #555555;">#&gt; </span><span style="color: #BBBB00; font-weight: bold;"> - incubation:</span></span></span>
<span><span class="co"><span style="color: #BBBB00; font-weight: bold;">#&gt; </span><span style="color: #555555;">   Transition: [E -1, I +1]</span></span></span>
<span><span class="co"><span style="color: #555555;">#&gt; </span><span style="color: #BBBB00; font-weight: bold;"> - recovery:</span></span></span>
<span><span class="co"><span style="color: #BBBB00; font-weight: bold;">#&gt; </span><span style="color: #555555;">   Transition: [I -1, R +1]</span></span></span>
<span><span class="co"><span style="color: #555555;">#&gt; </span><span style="color: #BBBB00; font-weight: bold;"> - case_detection:</span></span></span>
<span><span class="co"><span style="color: #BBBB00; font-weight: bold;">#&gt; </span><span style="color: #555555;">   Transition: [C +1]</span></span></span>
<span><span class="co"><span style="color: #555555;">#&gt; </span><span style="color: #BBBB00; font-weight: bold;"> - vaccinate:</span></span></span>
<span><span class="co"><span style="color: #BBBB00; font-weight: bold;">#&gt; </span><span style="color: #555555;">   Transition: [V +1, S -1]</span></span></span>
<span><span class="co"><span style="color: #555555;">#&gt; </span></span></span></code></pre></div>
<p>To run with default settings, just use the <code>run_sim</code>
function</p>
<p><img src="brech_files/figure-html/unnamed-chunk-3-1.png" class="r-plt" alt="" width="700"></p>
</div>
<div class="section level2">
<h2 id="model-fitting">Model fitting<a class="anchor" aria-label="anchor" href="#model-fitting"></a>
</h2>
<p>Approximate Bayesian Computation (ABC) is used to perform model
fitting. This is done by defining a summary statistic and then running
the summary statistic on the data. We will use the data above as an
example and create a summary statistic for the cumulative number of
cases after 10 days.</p>
<p>We then draw priors from a defined distribution for each parameter to
be fit. In the example below the parameter <code>beta</code> if fit to
the cumulative number of cases.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># generate summary statistics from run</span></span>
<span><span class="co"># These are the number of cases on a given day</span></span>
<span><span class="va">daily_cases</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="../reference/get_daily_cases.html">get_daily_cases</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span><span class="op">$</span><span class="va">daily_incidence</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># simulate from prior</span></span>
<span><span class="va">priors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span><span class="st">"beta"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">200</span>,mean<span class="op">=</span><span class="fl">0.1</span>,sd<span class="op">=</span><span class="fl">0.1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># statistical summary of simulation</span></span>
<span><span class="va">stat_func</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">m</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co">#' get total cases </span></span>
<span>  <span class="va">m</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/get_daily_cases.html">get_daily_cases</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>total_cases<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">daily_incidence</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/abc_stochastic_model.html">abc_stochastic_model</a></span><span class="op">(</span><span class="va">sm</span>,<span class="va">priors</span>,<span class="va">daily_cases</span>,<span class="va">stat_func</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">res</span>,param <span class="op">=</span> <span class="st">"beta"</span><span class="op">)</span></span></code></pre></div>
<p><img src="brech_files/figure-html/unnamed-chunk-4-1.png" class="r-plt" alt="" width="700"></p>
<p>We can similarly fit to daily cases. Note that we need to exclude the
first few days in the simulation where the variance in case incidence is
too low. Fitting the incidence appears to improve the model fit with
this small sample.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># simulate from prior</span></span>
<span><span class="va">priors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span><span class="st">"beta"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">200</span>,mean<span class="op">=</span><span class="fl">0.1</span>,sd<span class="op">=</span><span class="fl">0.1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># statistical summary of simulation</span></span>
<span><span class="va">stat_func</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">m</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co">#' get total cases </span></span>
<span>  <span class="va">m</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="../reference/get_daily_cases.html">get_daily_cases</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">day</span> <span class="op">&gt;</span> <span class="fl">3</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html" class="external-link">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="st">"day"</span>,values_from<span class="op">=</span><span class="st">"daily_incidence"</span>, </span>
<span>                names_prefix <span class="op">=</span> <span class="st">"day_"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">daily_cases</span> <span class="op">&lt;-</span> <span class="fu">stat_func</span><span class="op">(</span><span class="va">r</span><span class="op">)</span></span>
<span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/abc_stochastic_model.html">abc_stochastic_model</a></span><span class="op">(</span><span class="va">sm</span>,<span class="va">priors</span>,<span class="va">daily_cases</span>,<span class="va">stat_func</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">res</span>, param <span class="op">=</span> <span class="st">"beta"</span><span class="op">)</span></span></code></pre></div>
<p><img src="brech_files/figure-html/unnamed-chunk-5-1.png" class="r-plt" alt="" width="700"></p>
<p>The fit also provides the final state of each simulation from the
posterior which we can compare to our fitted data</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">time</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">time</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"true value"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">state</span>,type<span class="op">=</span><span class="st">"posterior"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="va">type</span>,names_to <span class="op">=</span> <span class="st">"state"</span>, values_to <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">state</span>,y<span class="op">=</span><span class="va">value</span>,color<span class="op">=</span><span class="va">type</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_jitter.html" class="external-link">geom_jitter</a></span><span class="op">(</span>alpha<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span></span></code></pre></div>
<p><img src="brech_files/figure-html/unnamed-chunk-6-1.png" class="r-plt" alt="" width="700"></p>
</div>
<div class="section level2">
<h2 id="scenario-projection">Scenario projection<a class="anchor" aria-label="anchor" href="#scenario-projection"></a>
</h2>
<p>We can then perform projections using a
<code>abc_stochastic_model</code> object. The projection will sample
over the final state of the model in the posterior as well as any
associated parameters and inherit other parameters from the underlying
<code>stochastic_model</code> class. We project forward in time using
the <code>projection_stochastic_model</code> function which also comes
with default plotting behaviour.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">projections</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/projection_stochastic_model.html">projection_stochastic_model</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">projections</span>, state <span class="op">=</span> <span class="st">"I"</span><span class="op">)</span></span></code></pre></div>
<p><img src="brech_files/figure-html/unnamed-chunk-7-1.png" class="r-plt" alt="" width="700"></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">projections</span>, state <span class="op">=</span> <span class="st">"C"</span><span class="op">)</span></span></code></pre></div>
<p><img src="brech_files/figure-html/unnamed-chunk-7-2.png" class="r-plt" alt="" width="700"></p>
<p>The <code>projection_stochastic_model</code> function can also
incorporate scenarios directly without the need for model fitting. This
is useful if there is a need to project under different scenarios where
there is no current data to inform the model fit. Under this scenario we
draw from a defined distribution of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>β</mi><annotation encoding="application/x-tex">\beta</annotation></semantics></math>
parameters</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">parameters</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span><span class="st">"beta"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">200</span>,min<span class="op">=</span><span class="fl">0.08</span>,max<span class="op">=</span><span class="fl">0.12</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">scenarios</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/scenario_stochastic_model.html">scenario_stochastic_model</a></span><span class="op">(</span><span class="va">sm</span>,<span class="va">parameters</span><span class="op">)</span></span>
<span><span class="va">projections</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/projection_stochastic_model.html">projection_stochastic_model</a></span><span class="op">(</span><span class="va">scenarios</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">projections</span>, state <span class="op">=</span> <span class="st">"I"</span><span class="op">)</span></span></code></pre></div>
<p><img src="brech_files/figure-html/unnamed-chunk-8-1.png" class="r-plt" alt="" width="700"></p>
<p>A flow chart of the dependency between defined S3 classes in the
package is provided below. The base class is
<code>stochastic_model</code> which defines the model events, rates,
parameters and initial states. A <code>summary</code> of the object can
be provided and a simulation can be drawn from the model using the
function <code><a href="../reference/stochastic_model.html">run_sim()</a></code>. Model fitting can be performed using
the <code>abc_stochastic_model</code> or alternatively a scenario can be
generated using the <code>scenario_stochastic_model</code> class.
Finally a projection can be generated from either a scenario or model
fit using <code>projection_stochastic_model</code>.</p>
<pre class="mermaid"><code>flowchart TD
  M("load_parameters()") --&gt; A
  R("reactions") --&gt; A
  A[stochastic_model] --&gt; B[abc_stochastic_model]
  A --&gt; C[scenario_stochastic_model]
  B --&gt; D[projection_stochastic_model]
  C --&gt; D</code></pre>
</div>
<div class="section level2">
<h2 id="age-structured-model">Age-structured model<a class="anchor" aria-label="anchor" href="#age-structured-model"></a>
</h2>
<p>For an age structured model we need to set-up reactions for each
age-group. This can be done explicitly as above, however would quickly
become cumbersome for a large number of age-groups. Instead we can
construct this by looping over age groups and defining each of the
reactions e.g. “infection” and “recovery”. This requires that the rates
functions are built inside a function factory to ensure that the correct
age-parameters are provided to each function. For more information see
<a href="https://adv-r.hadley.nz/function-factories.html" class="external-link">this
chapter</a>.</p>
<p>First we construct a simple contact age contact matrix with two age
groups,</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">age_groups</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"&lt;18"</span>, <span class="st">"18+"</span><span class="op">)</span></span>
<span><span class="va">contact_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">20</span>,<span class="fl">5</span>,<span class="fl">5</span>,<span class="fl">10</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">contact_matrix</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">age_groups</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">contact_matrix</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">age_groups</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">contact_matrix</span><span class="op">)</span></span>
<span><span class="co">#&gt;     &lt;18 18+</span></span>
<span><span class="co">#&gt; &lt;18  20   5</span></span>
<span><span class="co">#&gt; 18+   5  10</span></span></code></pre></div>
<p>Next we use the <code>age_groups</code> and
<code>contact_matrix</code> to populate the <code>reactions</code> list.
To illustrate the code below provides a simple age-structured SIR model.
We encapsulate this inside a function to ensure that variables such as
<code>age_groups</code> can be referenced later.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">create_custom_reactions</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">contact_matrix</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">age_groups</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">contact_matrix</span><span class="op">)</span></span>
<span>  <span class="va">reactions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">age_groups</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>        <span class="va">age_group</span> <span class="op">&lt;-</span> <span class="va">age_groups</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>        <span class="co">###########################</span></span>
<span>        <span class="co">#  infection transitions  #</span></span>
<span>        <span class="co">###########################</span></span>
<span>        <span class="va">transition</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="va">trans</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>          <span class="va">trans</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"S_"</span>,<span class="va">age_group</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">1</span></span>
<span>          <span class="va">trans</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"I_"</span>,<span class="va">age_group</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">+</span><span class="fl">1</span></span>
<span>          <span class="va">trans</span></span>
<span>        <span class="op">}</span></span>
<span>        <span class="va">rate</span> <span class="op">&lt;-</span> </span>
<span>          <span class="kw">function</span><span class="op">(</span><span class="va">i</span>,<span class="va">age_group</span><span class="op">)</span><span class="op">{</span></span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/force.html" class="external-link">force</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span></span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/force.html" class="external-link">force</a></span><span class="op">(</span><span class="va">age_group</span><span class="op">)</span></span>
<span>            <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">p</span>, <span class="va">t</span><span class="op">)</span> <span class="op">{</span></span>
<span>              <span class="va">I</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"I_"</span>, <span class="va">age_groups</span><span class="op">)</span><span class="op">]</span></span>
<span>              <span class="va">S</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"S_"</span>, <span class="va">age_group</span><span class="op">)</span><span class="op">]</span> </span>
<span>              <span class="va">lambda</span> <span class="op">&lt;-</span> <span class="va">p</span><span class="op">$</span><span class="va">beta</span> <span class="op">*</span> <span class="va">S</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">contact_matrix</span><span class="op">[</span>,<span class="va">i</span><span class="op">]</span> <span class="op">*</span> <span class="op">(</span><span class="va">I</span> <span class="op">/</span> <span class="va">p</span><span class="op">$</span><span class="va">N</span><span class="op">)</span><span class="op">)</span></span>
<span>              <span class="va">lambda</span>  </span>
<span>            <span class="op">}</span></span>
<span>          <span class="op">}</span></span>
<span>        <span class="va">reactions</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"infection_"</span>,<span class="va">age_group</span><span class="op">)</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>          <span class="st">"transition"</span><span class="op">=</span><span class="fu">transition</span><span class="op">(</span><span class="op">)</span>,</span>
<span>          <span class="st">"rate"</span> <span class="op">=</span> <span class="fu">rate</span><span class="op">(</span><span class="va">i</span>,<span class="va">age_group</span><span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>        <span class="co">##############################</span></span>
<span>        <span class="co">#    recovery transitions    #</span></span>
<span>        <span class="co">############################## </span></span>
<span>        <span class="va">transition</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="va">trans</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>          <span class="va">trans</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"I_"</span>,<span class="va">age_group</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">1</span></span>
<span>          <span class="va">trans</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"R_"</span>,<span class="va">age_group</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>          <span class="va">trans</span></span>
<span>        <span class="op">}</span></span>
<span>        <span class="va">rate</span> <span class="op">&lt;-</span> </span>
<span>        <span class="kw">function</span><span class="op">(</span><span class="va">age_group</span><span class="op">)</span><span class="op">{</span></span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/force.html" class="external-link">force</a></span><span class="op">(</span><span class="va">age_group</span><span class="op">)</span></span>
<span>          <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">p</span>, <span class="va">t</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="va">I</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"I_"</span>, <span class="va">age_group</span><span class="op">)</span><span class="op">]</span></span>
<span>            <span class="va">p</span><span class="op">$</span><span class="va">gamma</span> <span class="op">*</span> <span class="va">I</span></span>
<span>          <span class="op">}</span></span>
<span>        <span class="op">}</span></span>
<span>        <span class="va">reactions</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"recovery_"</span>,<span class="va">age_group</span><span class="op">)</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>          <span class="st">"transition"</span><span class="op">=</span><span class="fu">transition</span><span class="op">(</span><span class="op">)</span>,</span>
<span>          <span class="st">"rate"</span> <span class="op">=</span> <span class="fu">rate</span><span class="op">(</span><span class="va">age_group</span><span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>      </span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">reactions</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">reactions</span> <span class="op">&lt;-</span> <span class="fu">create_custom_reactions</span><span class="op">(</span><span class="va">contact_matrix</span><span class="op">)</span></span></code></pre></div>
<p>We then apply these reactions to construct a
<code>stochastic_model</code> object. We use the function
<code>create_age_initial_conditions</code> to convert the initial
conditions from a vector format to the format required for the
object.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">age_scenario</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>beta <span class="op">=</span> <span class="fl">0.5</span>, gamma <span class="op">=</span> <span class="fl">0.2</span>, N <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span>,</span>
<span>  initial_states <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    S <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">200</span>, <span class="fl">800</span><span class="op">)</span>,</span>
<span>    V <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>    I <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>    R <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>                    </span>
<span>    <span class="op">)</span>,</span>
<span>  sim_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>T <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">age_scenario</span> <span class="op">&lt;-</span> <span class="va">age_scenario</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/create_age_initial_conditions.html">create_age_initial_conditions</a></span><span class="op">(</span><span class="va">age_groups</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">sm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stochastic_model.html">stochastic_model</a></span><span class="op">(</span><span class="va">reactions</span>,<span class="va">age_scenario</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">sm</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB; font-weight: bold;">Stochastic Model</span> </span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">==================</span> </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BB00; font-weight: bold;">Initial Values:</span></span></span>
<span><span class="co">#&gt;   <span style="font-weight: bold;">S_&lt;18</span> : 200  <span style="font-weight: bold;">S_18+</span> : 800  <span style="font-weight: bold;">V_&lt;18</span> : 0</span></span>
<span><span class="co">#&gt;   <span style="font-weight: bold;">V_18+</span> : 0  <span style="font-weight: bold;">I_&lt;18</span> : 1  <span style="font-weight: bold;">I_18+</span> : 0</span></span>
<span><span class="co">#&gt;   <span style="font-weight: bold;">R_&lt;18</span> : 0  <span style="font-weight: bold;">R_18+</span> : 0</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00; font-weight: bold;">Parameters:</span></span></span>
<span><span class="co">#&gt;   <span style="font-weight: bold;">beta</span> : 0.5  <span style="font-weight: bold;">gamma</span> : 0.2  <span style="font-weight: bold;">N</span> : 1000</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BB00; font-weight: bold;">Simulation arguments:</span></span></span>
<span><span class="co">#&gt;   <span style="font-weight: bold;">T</span> : 10</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00; font-weight: bold;">Reactions:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;"> - infection_&lt;18:</span></span></span>
<span><span class="co"><span style="color: #BBBB00; font-weight: bold;">#&gt; </span><span style="color: #555555;">   Transition: [S_&lt;18 -1, I_&lt;18 +1]</span></span></span>
<span><span class="co"><span style="color: #555555;">#&gt; </span><span style="color: #BBBB00; font-weight: bold;"> - recovery_&lt;18:</span></span></span>
<span><span class="co"><span style="color: #BBBB00; font-weight: bold;">#&gt; </span><span style="color: #555555;">   Transition: [I_&lt;18 -1, R_&lt;18 +1]</span></span></span>
<span><span class="co"><span style="color: #555555;">#&gt; </span><span style="color: #BBBB00; font-weight: bold;"> - infection_18+:</span></span></span>
<span><span class="co"><span style="color: #BBBB00; font-weight: bold;">#&gt; </span><span style="color: #555555;">   Transition: [S_18+ -1, I_18+ +1]</span></span></span>
<span><span class="co"><span style="color: #555555;">#&gt; </span><span style="color: #BBBB00; font-weight: bold;"> - recovery_18+:</span></span></span>
<span><span class="co"><span style="color: #BBBB00; font-weight: bold;">#&gt; </span><span style="color: #555555;">   Transition: [I_18+ -1, R_18+ +1]</span></span></span>
<span><span class="co"><span style="color: #555555;">#&gt; </span></span></span></code></pre></div>
<p>As before we can run this simulation and plot</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span> <span class="op">&lt;-</span> <span class="va">sm</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/stochastic_model.html">run_sim</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span></span>
<span>      cols <span class="op">=</span> <span class="fu">tidyselect</span><span class="fu">::</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"I_"</span><span class="op">)</span>,</span>
<span>      names_to <span class="op">=</span> <span class="st">"age_group"</span>,</span>
<span>      names_prefix <span class="op">=</span> <span class="st">"I_"</span>,</span>
<span>      values_to <span class="op">=</span> <span class="st">"I"</span></span>
<span>    <span class="op">)</span></span>
<span><span class="va">r</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">time</span>,y<span class="op">=</span><span class="va">I</span>, color<span class="op">=</span> <span class="va">age_group</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="brech_files/figure-html/unnamed-chunk-13-1.png" class="r-plt" alt="" width="700"></p>
<p>We can also vaccinate the initial population by age group. In the
example below we imagine that the &lt;18 age group is 10% vaccinated and
the 18+ age group is 90% vaccinated. Notice that the initial values are
now updated.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">sm</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/vaccinate_initial_conditions.html">vaccinate_initial_conditions</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"&lt;18"</span><span class="op">=</span><span class="fl">0.1</span>,<span class="st">"18+"</span><span class="op">=</span><span class="fl">0.9</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB; font-weight: bold;">Stochastic Model</span> </span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">==================</span> </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BB00; font-weight: bold;">Initial Values:</span></span></span>
<span><span class="co">#&gt;   <span style="font-weight: bold;">S_&lt;18</span> : 180  <span style="font-weight: bold;">S_18+</span> : 80  <span style="font-weight: bold;">V_&lt;18</span> : 20</span></span>
<span><span class="co">#&gt;   <span style="font-weight: bold;">V_18+</span> : 720  <span style="font-weight: bold;">I_&lt;18</span> : 1  <span style="font-weight: bold;">I_18+</span> : 0</span></span>
<span><span class="co">#&gt;   <span style="font-weight: bold;">R_&lt;18</span> : 0  <span style="font-weight: bold;">R_18+</span> : 0</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00; font-weight: bold;">Parameters:</span></span></span>
<span><span class="co">#&gt;   <span style="font-weight: bold;">beta</span> : 0.5  <span style="font-weight: bold;">gamma</span> : 0.2  <span style="font-weight: bold;">N</span> : 1000</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BB00; font-weight: bold;">Simulation arguments:</span></span></span>
<span><span class="co">#&gt;   <span style="font-weight: bold;">T</span> : 10</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00; font-weight: bold;">Reactions:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;"> - infection_&lt;18:</span></span></span>
<span><span class="co"><span style="color: #BBBB00; font-weight: bold;">#&gt; </span><span style="color: #555555;">   Transition: [S_&lt;18 -1, I_&lt;18 +1]</span></span></span>
<span><span class="co"><span style="color: #555555;">#&gt; </span><span style="color: #BBBB00; font-weight: bold;"> - recovery_&lt;18:</span></span></span>
<span><span class="co"><span style="color: #BBBB00; font-weight: bold;">#&gt; </span><span style="color: #555555;">   Transition: [I_&lt;18 -1, R_&lt;18 +1]</span></span></span>
<span><span class="co"><span style="color: #555555;">#&gt; </span><span style="color: #BBBB00; font-weight: bold;"> - infection_18+:</span></span></span>
<span><span class="co"><span style="color: #BBBB00; font-weight: bold;">#&gt; </span><span style="color: #555555;">   Transition: [S_18+ -1, I_18+ +1]</span></span></span>
<span><span class="co"><span style="color: #555555;">#&gt; </span><span style="color: #BBBB00; font-weight: bold;"> - recovery_18+:</span></span></span>
<span><span class="co"><span style="color: #BBBB00; font-weight: bold;">#&gt; </span><span style="color: #555555;">   Transition: [I_18+ -1, R_18+ +1]</span></span></span>
<span><span class="co"><span style="color: #555555;">#&gt; </span></span></span></code></pre></div>
<p>We can similarly generate projections using the
<code>scenario_stochastic_model</code> object,</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">parameters</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span><span class="st">"beta"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">200</span>,min<span class="op">=</span><span class="fl">0.08</span>,max<span class="op">=</span><span class="fl">0.12</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">scenarios</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/scenario_stochastic_model.html">scenario_stochastic_model</a></span><span class="op">(</span><span class="va">sm</span>,<span class="va">parameters</span><span class="op">)</span></span>
<span><span class="va">projections</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/projection_stochastic_model.html">projection_stochastic_model</a></span><span class="op">(</span><span class="va">scenarios</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">projections</span>, state <span class="op">=</span> <span class="st">"I"</span><span class="op">)</span></span></code></pre></div>
<p><img src="brech_files/figure-html/unnamed-chunk-15-1.png" class="r-plt" alt="" width="700"></p>
<p>A series of helper functions can also be used to construct quantiles
and plot summaries from an age-structured model as long as the states
are named in the format <code>{model_state}_{age_group}</code>.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">projections</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="../reference/projection_stochastic_model.html">projection_quantiles_by_age_group</a></span><span class="op">(</span><span class="st">"I"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/projection_stochastic_model.html">plot_projections_by_age_group</a></span><span class="op">(</span><span class="st">"I"</span><span class="op">)</span></span></code></pre></div>
<p><img src="brech_files/figure-html/unnamed-chunk-16-1.png" class="r-plt" alt="" width="700"></p>
<p>The final state can also be extracted by first making the projections
longer and then examining the recovered individuals at the max time,</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">projections</span><span class="op">$</span><span class="va">projection</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/projection_stochastic_model.html">create_age_group_column</a></span><span class="op">(</span><span class="st">"R"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">time</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill<span class="op">=</span><span class="va">age_group</span>,x<span class="op">=</span><span class="va">R</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span>alpha<span class="op">=</span><span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Final size"</span>,fill<span class="op">=</span><span class="st">""</span><span class="op">)</span></span></code></pre></div>
<p><img src="brech_files/figure-html/unnamed-chunk-17-1.png" class="r-plt" alt="" width="700"></p>
</div>
<div class="section level2">
<h2 id="fitting-initial-conditions">Fitting initial conditions<a class="anchor" aria-label="anchor" href="#fitting-initial-conditions"></a>
</h2>
<p><code>abc_stochastic_model</code> can also take in initial states in
its fitting using the optional <code>states</code> argument. This needs
to be a complete model state for each row e.g.,</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">N</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">200</span>,<span class="fl">800</span><span class="op">)</span></span>
<span><span class="va">vaccine_rate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="va">infection_rate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.02</span>,<span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="va">nsamples</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span><span class="va">V</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">nsamples</span>, size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">N</span>, times <span class="op">=</span> <span class="va">nsamples</span><span class="op">)</span>, </span>
<span>              prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">vaccine_rate</span>, times <span class="op">=</span> <span class="va">nsamples</span><span class="op">)</span><span class="op">)</span>,</span>
<span>       nrow <span class="op">=</span> <span class="va">nsamples</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">S</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">N</span>,times<span class="op">=</span><span class="va">nsamples</span><span class="op">)</span>, nrow<span class="op">=</span><span class="va">nsamples</span>,byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">-</span> <span class="va">V</span></span>
<span><span class="co"># simulation initial infections </span></span>
<span><span class="va">I</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">nsamples</span>, size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">N</span>, times <span class="op">=</span> <span class="va">nsamples</span><span class="op">)</span>, </span>
<span>              prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">infection_rate</span>, times <span class="op">=</span> <span class="va">nsamples</span><span class="op">)</span><span class="op">)</span>,</span>
<span>       nrow <span class="op">=</span> <span class="va">nsamples</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">zero_state</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>,times<span class="op">=</span><span class="fl">2</span><span class="op">*</span><span class="va">nsamples</span><span class="op">)</span>, nrow<span class="op">=</span><span class="va">nsamples</span><span class="op">)</span></span>
<span><span class="va">states</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">S</span>, <span class="va">V</span>, <span class="va">I</span>, <span class="va">zero_state</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">states</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"S_&lt;18"</span>, <span class="st">"S_18+"</span>, <span class="st">"V_&lt;18"</span>, <span class="st">"V_18+"</span>, </span>
<span>                      <span class="st">"I_&lt;18"</span>, <span class="st">"I_18+"</span>, <span class="st">"R_&lt;18"</span>, <span class="st">"R_18+"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">states</span><span class="op">)</span></span>
<span><span class="co">#&gt;   S_&lt;18 S_18+ V_&lt;18 V_18+ I_&lt;18 I_18+ R_&lt;18 R_18+</span></span>
<span><span class="co">#&gt; 1   188   412    12   388    12    10     0     0</span></span>
<span><span class="co">#&gt; 2   178   401    22   399     4     8     0     0</span></span>
<span><span class="co">#&gt; 3   183   384    17   416     3     8     0     0</span></span>
<span><span class="co">#&gt; 4   183   384    17   416     4     5     0     0</span></span>
<span><span class="co">#&gt; 5   184   376    16   424     5     2     0     0</span></span>
<span><span class="co">#&gt; 6   175   414    25   386     5     3     0     0</span></span></code></pre></div>
<p>We can also project from a set of states with associated
parameters</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># fix beta parameter</span></span>
<span><span class="va">sm</span> <span class="op">&lt;-</span> <span class="va">sm</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/stochastic_model.html">update_parameters</a></span><span class="op">(</span>beta <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># define scenario based on list of states</span></span>
<span><span class="va">example_scenario</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/scenario_stochastic_model.html">scenario_stochastic_model</a></span><span class="op">(</span><span class="va">sm</span>, states <span class="op">=</span> <span class="va">states</span><span class="op">)</span></span>
<span><span class="va">state_projections</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/projection_stochastic_model.html">projection_stochastic_model</a></span><span class="op">(</span><span class="va">example_scenario</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">state_projections</span>, state <span class="op">=</span> <span class="st">"I"</span><span class="op">)</span></span></code></pre></div>
<p><img src="brech_files/figure-html/unnamed-chunk-19-1.png" class="r-plt" alt="" width="700"></p>
<p>We can perform model fitting as before using the <code>states</code>
as a prior in the model that it is sampled from. In the example below we
generate some data with an initial distribution of vaccinated among
children and adults and use the number of recovered in each age group as
the summary function.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">age_scenario</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>beta <span class="op">=</span> <span class="fl">0.1</span>, gamma <span class="op">=</span> <span class="fl">0.2</span>, N <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span>,</span>
<span>  initial_states <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    S <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">190</span>, <span class="fl">400</span><span class="op">)</span>,</span>
<span>    V <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">400</span><span class="op">)</span>,</span>
<span>    I <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>    R <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>                    </span>
<span>    <span class="op">)</span>,</span>
<span>  sim_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>T <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">age_scenario</span> <span class="op">&lt;-</span> <span class="va">age_scenario</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/create_age_initial_conditions.html">create_age_initial_conditions</a></span><span class="op">(</span><span class="va">age_groups</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">sm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stochastic_model.html">stochastic_model</a></span><span class="op">(</span><span class="va">reactions</span>,<span class="va">age_scenario</span><span class="op">)</span></span>
<span></span>
<span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stochastic_model.html">run_sim</a></span><span class="op">(</span><span class="va">sm</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">stat_func</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">m</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co">#' get total cases by age group</span></span>
<span>  <span class="va">m</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/startsWith.html" class="external-link">startsWith</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span>,<span class="st">"R"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">cumulative_cases</span> <span class="op">&lt;-</span> <span class="fu">stat_func</span><span class="op">(</span><span class="va">r</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># simulate from prior</span></span>
<span><span class="va">priors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span><span class="st">"beta"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span>,mean<span class="op">=</span><span class="fl">0.1</span>,sd<span class="op">=</span><span class="fl">0.1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/abc_stochastic_model.html">abc_stochastic_model</a></span><span class="op">(</span><span class="va">sm</span>,<span class="va">priors</span>,<span class="va">cumulative_cases</span>,<span class="va">stat_func</span>,</span>
<span>                            states <span class="op">=</span> <span class="va">states</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">res</span>, param <span class="op">=</span> <span class="st">"beta"</span><span class="op">)</span></span></code></pre></div>
<p><img src="brech_files/figure-html/unnamed-chunk-21-1.png" class="r-plt" alt="" width="700"></p>
</div>
<div class="section level2">
<h2 id="using-multisession-and-progressr">Using <code>multisession</code> and <code>progressr</code><a class="anchor" aria-label="anchor" href="#using-multisession-and-progressr"></a>
</h2>
<p>Both <code>abc_stochastic_model</code> and
<code>projection_stochastic_model</code> can be parallelized using the
<code>future</code> package together with <a href="https://progressr.futureverse.org/" class="external-link"><code>progressr</code></a> to
generate a progress bar. For more complex and realistic models these
will be essential to speed up computation and monitor progress. An
example of its use with two workers is provided below,</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># set up multisession environment</span></span>
<span><span class="fu">plan</span><span class="op">(</span><span class="va">multisession</span>, workers <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># run projections in parallel</span></span>
<span><span class="fu">progressr</span><span class="fu">::</span><span class="fu"><a href="https://progressr.futureverse.org/reference/with_progress.html" class="external-link">with_progress</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">state_projections</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/projection_stochastic_model.html">projection_stochastic_model</a></span><span class="op">(</span><span class="va">example_scenario</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Mike Irvine.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
